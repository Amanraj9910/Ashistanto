name: Build & Deploy to Azure Web App (Container)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_REGISTRY: ashistanto.azurecr.io
  IMAGE_NAME: azure-voice-ai
  APP_NAME: Ashistanto
  RESOURCE_GROUP: ai-102

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  # =========================================================
  # BUILD & PUSH IMAGE TO ACR
  # =========================================================
  build:
    name: üê≥ Build & Push Image
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.MICROSOFT_CLIENT_ID }}
          tenant-id: ${{ secrets.MICROSOFT_TENANT_ID }}
          subscription-id: ${{ secrets.MICROSOFT_SUBSCRIPTION_ID }}

      - name: üîë Login to ACR
        run: az acr login --name ashistanto

      - name: üê≥ Build & Push Docker Image
        run: |
          docker build \
            -t ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push \
            ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # =========================================================
  # DEPLOY TO AZURE WEB APP
  # =========================================================
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: üîê Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.MICROSOFT_CLIENT_ID }}
          tenant-id: ${{ secrets.MICROSOFT_TENANT_ID }}
          subscription-id: ${{ secrets.MICROSOFT_SUBSCRIPTION_ID }}

      - name: üöÄ Deploy Container to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          images: ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: ‚è≥ Wait for App Startup
        run: sleep 40

      - name: üè• Health Check
        run: |
          echo "Checking application health..."
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ashistanto.azurewebsites.net || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ App is healthy"
              exit 0
            fi
            echo "‚è≥ Attempt $i - Status: $STATUS"
            sleep 15
          done
          echo "‚ùå Health check failed"
          exit 1
