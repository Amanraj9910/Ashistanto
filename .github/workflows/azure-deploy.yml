# Production-ready CI/CD Pipeline for Azure Voice AI
# Deploys containerized application to Azure App Service using OIDC authentication

name: Build and Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip Docker layer cache'
        required: false
        default: 'false'
        type: boolean

env:
  ACR_REGISTRY: ashistanto.azurecr.io
  IMAGE_NAME: azure-voice-ai
  APP_NAME: Ashistanto
  RESOURCE_GROUP: Ashistanto  # Update if different

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  # ============================================================================
  # BUILD: Build and push Docker image to ACR
  # ============================================================================
  build:
    name: ğŸ”¨ Build & Push
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Generate image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.run_number }}

      - name: ğŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.MICROSOFT_CLIENT_ID }}
          tenant-id: ${{ secrets.MICROSOFT_TENANT_ID }}
          subscription-id: ${{ secrets.MICROSOFT_SUBSCRIPTION_ID }}

      - name: ğŸ”‘ Login to Azure Container Registry
        run: az acr login --name ashistanto

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ Cache Docker layers
        uses: actions/cache@v4
        if: ${{ github.event.inputs.skip_cache != 'true' }}
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: ğŸ—ï¸ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.run_number }}

      # Prevent cache from growing unbounded
      - name: ğŸ§¹ Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: ğŸ“‹ Build Summary
        run: |
          echo "### ğŸ³ Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | \`${{ env.ACR_REGISTRY }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | \`${{ steps.meta.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # DEPLOY: Deploy container to Azure App Service
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    # Note: Removed 'environment' block to use branch-based OIDC subject
    # If you want environment protection rules, add a federated credential for:
    # subject: repo:Amanraj9910/Ashistanto:environment:production

    steps:
      - name: ğŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.MICROSOFT_CLIENT_ID }}
          tenant-id: ${{ secrets.MICROSOFT_TENANT_ID }}
          subscription-id: ${{ secrets.MICROSOFT_SUBSCRIPTION_ID }}

      - name: ğŸ”‘ Login to Azure Container Registry
        run: az acr login --name ashistanto

      - name: ğŸ“¦ Configure App Service for Container
        run: |
          # Ensure App Service is configured for container deployment
          az webapp config container set \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --docker-custom-image-name ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --docker-registry-server-url https://${{ env.ACR_REGISTRY }}

      - name: ğŸš€ Deploy Container to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          images: ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: â³ Wait for deployment to stabilize
        run: sleep 30

      - name: ğŸ¥ Health Check
        id: health_check
        run: |
          echo "Checking application health..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ashistanto.azurewebsites.net/api/config || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Health check passed! Status: $HTTP_STATUS"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "â³ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES - Status: $HTTP_STATUS"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 15
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: ğŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "### ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App Service | \`${{ env.APP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://ashistanto.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ steps.health_check.outputs.status || 'pending' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # NOTIFY: Post-deployment notifications (optional)
  # ============================================================================
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    steps:
      - name: ğŸ“Š Final Status
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application URL: https://ashistanto.azurewebsites.net"
          else
            echo "âŒ Deployment failed or was cancelled"
            echo "ğŸ” Check the workflow logs for details"
          fi
