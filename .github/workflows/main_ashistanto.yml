# ============================================================================
# DEPRECATED: This workflow has been replaced by azure-deploy.yml
# The new workflow uses OIDC authentication for enhanced security.
# Keeping this file for reference. Remove after confirming new pipeline works.
# ============================================================================

# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: "[DEPRECATED] Build and deploy container app to Azure Web App - Ashistanto"

# Disabled - using azure-deploy.yml instead
# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "confirm" to run this deprecated workflow'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
          registry: ashistanto.azurecr.io
          username: ${{ secrets.AZUREAPPSERVICE_CONTAINERUSERNAME_C8691C70F7FB4597944189AF581ABAFD }}
          password: ${{ secrets.AZUREAPPSERVICE_CONTAINERPASSWORD_A9B3385B692946FFBDD22342A1536B02 }}

      - name: Build and push container image to registry
        uses: docker/build-push-action@v3
        with:
          context: .
          push: true
          tags: ashistanto.azurecr.io/${{ secrets.AZUREAPPSERVICE_CONTAINERUSERNAME_C8691C70F7FB4597944189AF581ABAFD }}/azure-voice-ai:${{ github.sha }}
          file: ./Dockerfile

  deploy:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'Ashistanto'
          slot-name: 'Production'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: 'ashistanto.azurecr.io/${{ secrets.AZUREAPPSERVICE_CONTAINERUSERNAME_C8691C70F7FB4597944189AF581ABAFD }}/azure-voice-ai:${{ github.sha }}'