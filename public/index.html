<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Voice AI Agent</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        function VoiceAIAgent() {
          const [isRecording, setIsRecording] = useState(false);
          const [isProcessing, setIsProcessing] = useState(false);
          const [isSpeaking, setIsSpeaking] = useState(false);
          const [currentTranscript, setCurrentTranscript] = useState('');
          const [currentResponse, setCurrentResponse] = useState('');
          const [error, setError] = useState('');
          const [isConfigured, setIsConfigured] = useState(false);
          const [conversationMode, setConversationMode] = useState(false);
          const [messages, setMessages] = useState([]);
          const [sessionId, setSessionId] = useState(null); // Will be set after login
          const [isLoggedIn, setIsLoggedIn] = useState(false);
          const [userEmail, setUserEmail] = useState('');
          const [textInput, setTextInput] = useState(''); // New: text message input

          const mediaRecorderRef = useRef(null);
          const audioChunksRef = useRef([]);
          const audioRef = useRef(null);
          const streamRef = useRef(null);
          const messagesEndRef = useRef(null);

          // Auto-scroll to bottom of messages
          useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages]);

          // Check if backend is configured
          useEffect(() => {
            fetch('/api/config')
              .then(res => res.json())
              .then(data => {
                setIsConfigured(data.configured);
                if (!data.configured) {
                  setError('‚ö†Ô∏è Server not configured. Please set up your .env file with Azure credentials.');
                }
              })
              .catch(err => {
                setError('‚ùå Failed to connect to server. Make sure the server is running.');
              });
          }, []);

          // Check if user is logged in on component mount
          useEffect(() => {
            const checkLogin = async () => {
              // First check localStorage for sessionId
              const storedSessionId = localStorage.getItem('userSessionId');
              
              if (storedSessionId) {
                // Verify session is still valid by calling auth endpoint
                try {
                  const response = await fetch(`/auth/session-token/${storedSessionId}`);
                  if (response.ok) {
                    setSessionId(storedSessionId);
                    setIsLoggedIn(true);
                    // Try to get user info
                    fetchUserInfo();
                    return;
                  }
                } catch (err) {
                  console.log('Session expired or invalid');
                }
              }
              
              // If no valid session, redirect to login
              console.log('No valid session found. Redirecting to login...');
              window.location.href = '/auth/login';
            };
            
            checkLogin();
          }, []);

          const fetchUserInfo = async () => {
            try {
              const response = await fetch('/auth/user');
              const data = await response.json();
              if (data.email) {
                setUserEmail(data.email);
              }
            } catch (err) {
              console.error('Error fetching user info:', err);
            }
          };

          // Handle audio playback end for continuous mode
          useEffect(() => {
            const audio = audioRef.current;
            if (audio) {
              const handleEnded = () => {
                setIsSpeaking(false);
                if (conversationMode) {
                  setTimeout(() => {
                    startRecording();
                  }, 1000);
                }
              };
              
              audio.addEventListener('ended', handleEnded);
              return () => audio.removeEventListener('ended', handleEnded);
            }
          }, [conversationMode]);

          const startRecording = async () => {
            try {
              setError('');
              setCurrentTranscript('');
              setCurrentResponse('');
              
              const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                  echoCancellation: true,
                  noiseSuppression: true,
                  autoGainControl: true,
                  sampleRate: 16000
                } 
              });
              
              streamRef.current = stream;
              
              // Try to use the best available format
              let mimeType = 'audio/webm;codecs=opus';
              if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'audio/webm';
              }
              
              const mediaRecorder = new MediaRecorder(stream, { 
                mimeType: mimeType,
                audioBitsPerSecond: 128000
              });
              
              mediaRecorderRef.current = mediaRecorder;
              audioChunksRef.current = [];

              mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                  audioChunksRef.current.push(event.data);
                  console.log('Audio chunk received:', event.data.size, 'bytes');
                }
              };

              mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunksRef.current, { type: mimeType });
                console.log('Recording stopped. Total size:', audioBlob.size, 'bytes');
                
                if (audioBlob.size < 1000) {
                  setError('‚ùå Recording too short. Please speak for at least 1 second.');
                  setIsProcessing(false);
                  stream.getTracks().forEach(track => track.stop());
                  return;
                }
                
                await processAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
              };

              mediaRecorder.start(100); // Collect data every 100ms
              setIsRecording(true);
              console.log('Recording started with format:', mimeType);
              
              // Auto-stop after 10 seconds if in conversation mode
              if (conversationMode) {
                setTimeout(() => {
                  if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                    stopRecording();
                  }
                }, 10000);
              }
            } catch (err) {
              console.error('Microphone error:', err);
              setError('‚ùå Microphone access denied. Please allow microphone access and try again.');
            }
          };

          const stopRecording = () => {
            if (mediaRecorderRef.current && isRecording) {
              console.log('Stopping recording...');
              mediaRecorderRef.current.stop();
              setIsRecording(false);
              setIsProcessing(true);
            }
          };

          const processAudio = async (audioBlob) => {
            try {
              console.log('Processing audio, size:', audioBlob.size);
              
              const formData = new FormData();
              formData.append('audio', audioBlob, 'recording.webm');
              formData.append('sessionId', sessionId); // Send session ID

              const response = await fetch('/api/process-voice', {
                method: 'POST',
                body: formData
              });

              const data = await response.json();
              
              if (!response.ok) {
                throw new Error(data.error || 'Failed to process audio');
              }

              console.log('‚úì Response received:', {
                transcript: data.transcript,
                responseLength: data.agentResponse.length
              });
              
              setCurrentTranscript(data.transcript);
              setCurrentResponse(data.agentResponse);
              
              // Add to messages
              const newMessage = {
                id: Date.now(),
                user: data.transcript,
                ai: data.agentResponse,
                timestamp: new Date().toLocaleTimeString()
              };
              
              setMessages(prev => [...prev, newMessage]);

              // Play audio response
              if (data.audioData) {
                const audioBlob = new Blob(
                  [Uint8Array.from(atob(data.audioData), c => c.charCodeAt(0))],
                  { type: 'audio/mp3' }
                );
                const audioUrl = URL.createObjectURL(audioBlob);
                
                if (audioRef.current) {
                  audioRef.current.src = audioUrl;
                  setIsSpeaking(true);
                  await audioRef.current.play();
                }
              }
            } catch (err) {
              console.error('‚ùå Processing error:', err);
              setError('‚ùå ' + err.message);
              
              if (conversationMode) {
                setConversationMode(false);
              }
            } finally {
              setIsProcessing(false);
            }
          };

          const toggleConversationMode = () => {
            const newMode = !conversationMode;
            setConversationMode(newMode);
            
            if (newMode && !isRecording && !isProcessing && !isSpeaking) {
              startRecording();
            } else if (!newMode) {
              if (streamRef.current) {
                streamRef.current.getTracks().forEach(track => track.stop());
              }
              if (mediaRecorderRef.current && isRecording) {
                stopRecording();
              }
            }
          };

          const clearHistory = () => {
            setMessages([]);
            setCurrentTranscript('');
            setCurrentResponse('');
            setError('');
            
            // Clear server-side session
            fetch('/api/clear-session', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId })
            }).catch(err => console.error('Failed to clear session:', err));
          };

          const logout = () => {
            // Clear localStorage
            localStorage.removeItem('userSessionId');
            // Redirect to login
            window.location.href = '/auth/login';
          };

          const handleTextSubmit = async (e) => {
            e.preventDefault();
            
            if (!textInput.trim()) {
              return;
            }
            
            if (!sessionId || !isLoggedIn) {
              setError('‚ùå You must be logged in to send messages');
              return;
            }

            setIsProcessing(true);
            setError('');
            
            const userMessage = textInput.trim();
            setTextInput('');
            
            // Add user message to chat
            const messageId = Date.now();
            
            try {
              // Send text to agent
              const response = await fetch('/api/text-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: userMessage,
                  sessionId: sessionId
                })
              });

              if (!response.ok) {
                throw new Error(`Server error: ${response.statusText}`);
              }

              const data = await response.json();
              
              // Add both user and AI messages to chat
              setMessages(prev => [...prev, {
                id: messageId,
                user: userMessage,
                ai: data.response || 'No response',
                timestamp: new Date().toLocaleTimeString('en-US', { 
                  hour: '2-digit', 
                  minute: '2-digit',
                  second: '2-digit'
                })
              }]);

              setCurrentResponse(data.response || '');
            } catch (err) {
              console.error('Error sending message:', err);
              setError(`‚ùå Error sending message: ${err.message}`);
              
              // Still add the user message so they see what they sent
              setMessages(prev => [...prev, {
                id: messageId,
                user: userMessage,
                ai: '‚ùå Failed to get response. Please try again.',
                timestamp: new Date().toLocaleTimeString('en-US', { 
                  hour: '2-digit', 
                  minute: '2-digit',
                  second: '2-digit'
                })
              }]);
            } finally {
              setIsProcessing(false);
            }
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 p-4">
              <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                  <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                      <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                        üéôÔ∏è AI Voice Assistant
                      </h1>
                      <p className="text-gray-600 mt-1">Talk naturally with AI - powered by Azure</p>
                      {isLoggedIn && userEmail && (
                        <p className="text-sm text-green-600 mt-2">‚úÖ Logged in as: <strong>{userEmail}</strong></p>
                      )}
                    </div>
                    <div className="flex gap-3 flex-wrap">
                      <button
                        onClick={toggleConversationMode}
                        disabled={!isConfigured || !isLoggedIn}
                        className={`px-6 py-3 rounded-xl font-medium transition-all transform hover:scale-105 ${
                          conversationMode
                            ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        } ${!isConfigured || !isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`}
                      >
                        {conversationMode ? 'üîÑ Continuous Mode' : '‚è∏Ô∏è Single Mode'}
                      </button>
                      {messages.length > 0 && (
                        <button
                          onClick={clearHistory}
                          className="px-6 py-3 rounded-xl font-medium bg-red-100 text-red-700 hover:bg-red-200 transition"
                        >
                          üóëÔ∏è Clear
                        </button>
                      )}
                      {isLoggedIn && (
                        <button
                          onClick={logout}
                          className="px-6 py-3 rounded-xl font-medium bg-orange-100 text-orange-700 hover:bg-orange-200 transition"
                        >
                          üö™ Logout
                        </button>
                      )}
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  {/* Main Control Panel */}
                  <div className="lg:col-span-1">
                    <div className="bg-white rounded-2xl shadow-xl p-8 sticky top-6">
                      {error && (
                        <div className="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                          <div className="flex items-start gap-2">
                            <svg className="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                            </svg>
                            <span className="text-sm text-red-700">{error}</span>
                          </div>
                        </div>
                      )}

                      <div className="flex flex-col items-center">
                        <button
                          onClick={isRecording ? stopRecording : startRecording}
                          disabled={isProcessing || !isConfigured || conversationMode || !isLoggedIn}
                          className={`relative w-40 h-40 rounded-full flex items-center justify-center transition-all transform shadow-2xl ${
                            isRecording
                              ? 'bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 animate-pulse scale-110'
                              : isProcessing || isSpeaking
                              ? 'bg-gradient-to-br from-gray-400 to-gray-500 cursor-not-allowed'
                              : 'bg-gradient-to-br from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 hover:scale-105'
                          } ${!isConfigured || conversationMode || !isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`}
                        >
                          {isProcessing ? (
                            <svg className="animate-spin h-16 w-16 text-white" fill="none" viewBox="0 0 24 24">
                              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                          ) : isSpeaking ? (
                            <svg className="w-16 h-16 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            </svg>
                          ) : isRecording ? (
                            <div className="flex flex-col items-center">
                              <div className="w-16 h-16 bg-white rounded-lg animate-pulse"></div>
                              <span className="text-white text-sm mt-2 font-medium">STOP</span>
                            </div>
                          ) : (
                            <svg className="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                          )}
                        </button>
                        
                        <div className="mt-6 text-center">
                          <p className="text-lg font-semibold text-gray-800">
                            {!isLoggedIn
                              ? 'üîê Redirecting to login...'
                              : isProcessing
                              ? 'ü§î Processing...'
                              : isSpeaking
                              ? 'üîä AI Speaking...'
                              : isRecording
                              ? 'üéôÔ∏è Listening...'
                              : !isConfigured
                              ? '‚öôÔ∏è Not Configured'
                              : conversationMode
                              ? 'üîÑ Auto Mode Active'
                              : 'üëÜ Click to Speak'}
                          </p>
                          <p className="text-sm text-gray-500 mt-2">
                            {!isLoggedIn 
                              ? 'Please log in with your Microsoft account'
                              : isRecording ? 'Click button to stop recording' : 
                             conversationMode ? 'Conversation continues automatically' :
                             'Press and hold to record your message'}
                          </p>
                        </div>
                      </div>

                      <audio ref={audioRef} className="hidden" />
                    </div>
                  </div>

                  {/* Chat Messages */}
                  <div className="lg:col-span-2">
                    <div className="bg-white rounded-2xl shadow-xl p-6 h-[calc(100vh-12rem)] flex flex-col">
                      <div className="flex items-center justify-between mb-4 pb-4 border-b">
                        <h2 className="text-xl font-semibold text-gray-800">üí¨ Conversation</h2>
                        <span className="text-sm text-gray-500">{messages.length} messages</span>
                      </div>

                      {messages.length === 0 ? (
                        <div className="flex-1 flex items-center justify-center">
                          <div className="text-center text-gray-400">
                            <svg className="w-24 h-24 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <p className="text-lg font-medium">No messages yet</p>
                            <p className="text-sm mt-2">Start speaking or typing to begin your conversation</p>
                          </div>
                        </div>
                      ) : (
                        <div className="flex-1 overflow-y-auto space-y-4 pr-2 mb-4">
                          {messages.map((msg) => (
                            <div key={msg.id} className="space-y-3">
                              {/* User Message */}
                              <div className="flex justify-end">
                                <div className="max-w-[80%]">
                                  <div className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl rounded-tr-sm p-4 shadow-lg">
                                    <p className="text-sm leading-relaxed">{msg.user}</p>
                                  </div>
                                  <p className="text-xs text-gray-400 mt-1 text-right">{msg.timestamp}</p>
                                </div>
                              </div>

                              {/* AI Response */}
                              <div className="flex justify-start">
                                <div className="max-w-[80%]">
                                  <div className="bg-gray-100 text-gray-800 rounded-2xl rounded-tl-sm p-4 shadow-lg">
                                    <div className="flex items-start gap-2">
                                      <span className="text-2xl">ü§ñ</span>
                                      <p className="text-sm leading-relaxed flex-1">{msg.ai}</p>
                                    </div>
                                  </div>
                                  <p className="text-xs text-gray-400 mt-1">AI Assistant</p>
                                </div>
                              </div>
                            </div>
                          ))}
                          <div ref={messagesEndRef} />
                        </div>
                      )}
                      
                      {/* Text Input Area */}
                      <div className="border-t pt-4">
                        <form onSubmit={handleTextSubmit} className="flex gap-2">
                          <input
                            type="text"
                            value={textInput}
                            onChange={(e) => setTextInput(e.target.value)}
                            placeholder="Type your message..."
                            disabled={isProcessing || !isConfigured || !isLoggedIn}
                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                          />
                          <button
                            type="submit"
                            disabled={isProcessing || !isConfigured || !isLoggedIn || !textInput.trim()}
                            className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-medium hover:from-indigo-700 hover:to-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                          >
                            {isProcessing ? (
                              <>
                                <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Sending...
                              </>
                            ) : (
                              <>
                                <span>üì§</span>
                                Send
                              </>
                            )}
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Footer */}
                <div className="mt-6 text-center">
                  <p className="text-sm text-gray-600">
                    üí° <strong>Tip:</strong> Enable <strong>Continuous Mode</strong> for natural back-and-forth conversation
                  </p>
                  <p className="text-xs text-gray-500 mt-2">
                    Powered by Azure Speech Services & Azure OpenAI
                  </p>
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<VoiceAIAgent />, document.getElementById('root'));
    </script>
</body>
</html>