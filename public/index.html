<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Voice AI Agent</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        function VoiceAIAgent() {
          const [isRecording, setIsRecording] = useState(false);
          const [isProcessing, setIsProcessing] = useState(false);
          const [isSpeaking, setIsSpeaking] = useState(false);
          const [currentTranscript, setCurrentTranscript] = useState('');
          const [currentResponse, setCurrentResponse] = useState('');
          const [error, setError] = useState('');
          const [isConfigured, setIsConfigured] = useState(false);
          const [conversationMode, setConversationMode] = useState(false);
          const [messages, setMessages] = useState([]);
          const [sessionId, setSessionId] = useState(null);
          const [isLoggedIn, setIsLoggedIn] = useState(false);
          const [userEmail, setUserEmail] = useState('');
          const [textInput, setTextInput] = useState('');

          const mediaRecorderRef = useRef(null);
          const audioChunksRef = useRef([]);
          const audioRef = useRef(null);
          const streamRef = useRef(null);
          const messagesEndRef = useRef(null);

          useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages]);

          useEffect(() => {
            fetch('/api/config')
              .then(res => res.json())
              .then(data => {
                setIsConfigured(data.configured);
                if (!data.configured) {
                  setError('‚ö†Ô∏è Server not configured. Please set up your .env file with Azure credentials.');
                }
              })
              .catch(err => {
                setError('‚ùå Failed to connect to server. Make sure the server is running.');
              });
          }, []);

          useEffect(() => {
            const checkLogin = async () => {
              const storedSessionId = localStorage.getItem('userSessionId');
              
              if (storedSessionId) {
                try {
                  const response = await fetch(`/auth/session-token/${storedSessionId}`);
                  if (response.ok) {
                    setSessionId(storedSessionId);
                    setIsLoggedIn(true);
                    fetchUserInfo();
                    return;
                  }
                } catch (err) {
                  console.log('Session expired or invalid');
                }
              }
              
              console.log('No valid session found. Redirecting to login...');
              window.location.href = '/auth/login';
            };
            
            checkLogin();
          }, []);

          const fetchUserInfo = async () => {
            try {
              const response = await fetch('/auth/user');
              const data = await response.json();
              if (data.email) {
                setUserEmail(data.email);
              }
            } catch (err) {
              console.error('Error fetching user info:', err);
            }
          };

          useEffect(() => {
            const audio = audioRef.current;
            if (audio) {
              const handleEnded = () => {
                setIsSpeaking(false);
                if (conversationMode) {
                  setTimeout(() => {
                    startRecording();
                  }, 1000);
                }
              };
              
              audio.addEventListener('ended', handleEnded);
              return () => audio.removeEventListener('ended', handleEnded);
            }
          }, [conversationMode]);

          const startRecording = async () => {
            try {
              setError('');
              setCurrentTranscript('');
              setCurrentResponse('');
              
              const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                  echoCancellation: true,
                  noiseSuppression: true,
                  autoGainControl: true,
                  sampleRate: 16000
                } 
              });
              
              streamRef.current = stream;
              
              let mimeType = 'audio/webm;codecs=opus';
              if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'audio/webm';
              }
              
              const mediaRecorder = new MediaRecorder(stream, { 
                mimeType: mimeType,
                audioBitsPerSecond: 128000
              });
              
              mediaRecorderRef.current = mediaRecorder;
              audioChunksRef.current = [];

              mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                  audioChunksRef.current.push(event.data);
                }
              };

              mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunksRef.current, { type: mimeType });
                
                if (audioBlob.size < 1000) {
                  setError('‚ùå Recording too short. Please speak for at least 1 second.');
                  setIsProcessing(false);
                  stream.getTracks().forEach(track => track.stop());
                  return;
                }
                
                await processAudio(audioBlob);
                stream.getTracks().forEach(track => track.stop());
              };

              mediaRecorder.start(100);
              setIsRecording(true);
              
              if (conversationMode) {
                setTimeout(() => {
                  if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                    stopRecording();
                  }
                }, 10000);
              }
            } catch (err) {
              setError('‚ùå Microphone access denied. Please allow microphone access and try again.');
            }
          };

          const stopRecording = () => {
            if (mediaRecorderRef.current && isRecording) {
              mediaRecorderRef.current.stop();
              setIsRecording(false);
              setIsProcessing(true);
            }
          };

          const processAudio = async (audioBlob) => {
            try {
              const formData = new FormData();
              formData.append('audio', audioBlob, 'recording.webm');
              formData.append('sessionId', sessionId);

              const response = await fetch('/api/process-voice', {
                method: 'POST',
                body: formData
              });

              const data = await response.json();
              
              if (!response.ok) {
                throw new Error(data.error || 'Failed to process audio');
              }
              
              setCurrentTranscript(data.transcript);
              setCurrentResponse(data.agentResponse);
              
              const newMessage = {
                id: Date.now(),
                user: data.transcript,
                ai: data.agentResponse,
                timestamp: new Date().toLocaleTimeString()
              };
              
              setMessages(prev => [...prev, newMessage]);

              if (data.audioData) {
                const audioBlob = new Blob(
                  [Uint8Array.from(atob(data.audioData), c => c.charCodeAt(0))],
                  { type: 'audio/mp3' }
                );
                const audioUrl = URL.createObjectURL(audioBlob);
                
                if (audioRef.current) {
                  audioRef.current.src = audioUrl;
                  setIsSpeaking(true);
                  await audioRef.current.play();
                }
              }
            } catch (err) {
              setError('‚ùå ' + err.message);
              
              if (conversationMode) {
                setConversationMode(false);
              }
            } finally {
              setIsProcessing(false);
            }
          };

          const toggleConversationMode = () => {
            const newMode = !conversationMode;
            setConversationMode(newMode);
            
            if (newMode && !isRecording && !isProcessing && !isSpeaking) {
              startRecording();
            } else if (!newMode) {
              if (streamRef.current) {
                streamRef.current.getTracks().forEach(track => track.stop());
              }
              if (mediaRecorderRef.current && isRecording) {
                stopRecording();
              }
            }
          };

          const clearHistory = () => {
            setMessages([]);
            setCurrentTranscript('');
            setCurrentResponse('');
            setError('');
            
            fetch('/api/clear-session', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId })
            }).catch(err => console.error('Failed to clear session:', err));
          };

          const logout = () => {
            localStorage.removeItem('userSessionId');
            window.location.href = '/auth/login';
          };

          const handleTextSubmit = async (e) => {
            e.preventDefault();
            
            if (!textInput.trim()) {
              return;
            }
            
            if (!sessionId || !isLoggedIn) {
              setError('‚ùå You must be logged in to send messages');
              return;
            }

            setIsProcessing(true);
            setError('');
            
            const userMessage = textInput.trim();
            setTextInput('');
            
            const messageId = Date.now();
            
            try {
              const response = await fetch('/api/text-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: userMessage,
                  sessionId: sessionId
                })
              });

              if (!response.ok) {
                throw new Error(`Server error: ${response.statusText}`);
              }

              const data = await response.json();
              
              setMessages(prev => [...prev, {
                id: messageId,
                user: userMessage,
                ai: data.response || 'No response',
                timestamp: new Date().toLocaleTimeString('en-US', { 
                  hour: '2-digit', 
                  minute: '2-digit',
                  second: '2-digit'
                })
              }]);

              setCurrentResponse(data.response || '');
            } catch (err) {
              setError(`‚ùå Error sending message: ${err.message}`);
              
              setMessages(prev => [...prev, {
                id: messageId,
                user: userMessage,
                ai: '‚ùå Failed to get response. Please try again.',
                timestamp: new Date().toLocaleTimeString('en-US', { 
                  hour: '2-digit', 
                  minute: '2-digit',
                  second: '2-digit'
                })
              }]);
            } finally {
              setIsProcessing(false);
            }
          };

          return (
            <div className="min-h-screen bg-white">
              {/* Header Navigation */}
              <nav className="bg-white border-b border-gray-200 shadow-sm">
                <div className="max-w-7xl mx-auto px-6 py-4">
                  <div className="flex items-center justify-between">
                    {/* Logo */}
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center">
                        <span className="text-white font-bold text-xl">H</span>
                      </div>
                      <span className="text-xl font-bold text-gray-900">Hosho Digital</span>
                    </div>
                    
                    {/* Navigation Links */}
                    <div className="hidden md:flex items-center gap-1">
                      <button className="px-4 py-2 text-white bg-gradient-to-r from-red-500 to-red-600 rounded-lg font-medium hover:from-red-600 hover:to-red-700 transition">
                        Home
                      </button>
                      <button className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition">
                        Voice Processing
                      </button>
                      <button className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition">
                        Text Chat
                      </button>
                      <button className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition">
                        About
                      </button>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex items-center gap-3">
                      {isLoggedIn && (
                        <div className="hidden md:block text-sm text-gray-600">
                          {userEmail}
                        </div>
                      )}
                      <button
                        onClick={logout}
                        className="px-5 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg font-medium hover:from-red-600 hover:to-red-700 transition flex items-center gap-2"
                      >
                        <span>‚ö°</span>
                        Logout
                      </button>
                    </div>
                  </div>
                </div>
              </nav>

              {/* Hero Section */}
              <div className="bg-gradient-to-br from-gray-50 to-gray-100 py-20 px-6">
                <div className="max-w-5xl mx-auto text-center">
                  <h1 className="text-5xl md:text-6xl font-bold text-gray-900 mb-4">
                    Voice AI Assistant
                    <br />
                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-red-600">
                      Processing Platform
                    </span>
                  </h1>
                  <p className="text-xl text-gray-600 mb-10 max-w-3xl mx-auto">
                    Advanced AI-powered voice interaction with Microsoft 365 integration, 
                    real-time speech processing, and intelligent conversation capabilities.
                  </p>
                  
                  {/* Quick Action Buttons */}
                  <div className="flex flex-wrap justify-center gap-4">
                    <button
                      onClick={isRecording ? stopRecording : startRecording}
                      disabled={isProcessing || !isConfigured || conversationMode || !isLoggedIn}
                      className="px-8 py-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg font-semibold text-lg hover:from-red-600 hover:to-red-700 transition flex items-center gap-3 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <span>‚ö°</span>
                      {isRecording ? 'Stop Recording' : 'Start Processing'}
                    </button>
                    <button className="px-8 py-4 bg-white text-gray-700 rounded-lg font-semibold text-lg hover:bg-gray-50 transition border-2 border-gray-200 flex items-center gap-2">
                      Learn More
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                      </svg>
                    </button>
                  </div>

                  {/* Status Badge */}
                  {error && (
                    <div className="mt-8 inline-block">
                      <div className="bg-red-50 border border-red-200 rounded-lg px-6 py-3 text-red-700">
                        {error}
                      </div>
                    </div>
                  )}
                  
                  {isLoggedIn && !error && (
                    <div className="mt-8 inline-block">
                      <div className="bg-green-50 border border-green-200 rounded-lg px-6 py-3 text-green-700 flex items-center gap-2">
                        <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        System Ready - Connected as {userEmail}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Main Content */}
              <div className="max-w-7xl mx-auto px-6 py-12">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  {/* Control Panel */}
                  <div className="lg:col-span-1">
                    <div className="bg-white rounded-2xl border-2 border-gray-200 p-8 sticky top-6">
                      <h3 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <span className="w-8 h-8 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center text-white text-sm">
                          üéôÔ∏è
                        </span>
                        Voice Control
                      </h3>

                      <div className="flex flex-col items-center mb-8">
                        <button
                          onClick={isRecording ? stopRecording : startRecording}
                          disabled={isProcessing || !isConfigured || conversationMode || !isLoggedIn}
                          className={`relative w-36 h-36 rounded-full flex items-center justify-center transition-all transform shadow-xl ${
                            isRecording
                              ? 'bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 animate-pulse scale-110'
                              : isProcessing || isSpeaking
                              ? 'bg-gray-400 cursor-not-allowed'
                              : 'bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 hover:scale-105'
                          } ${!isConfigured || conversationMode || !isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`}
                        >
                          {isProcessing ? (
                            <svg className="animate-spin h-12 w-12 text-white" fill="none" viewBox="0 0 24 24">
                              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                          ) : isSpeaking ? (
                            <svg className="w-12 h-12 text-white animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            </svg>
                          ) : (
                            <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                          )}
                        </button>
                        
                        <div className="mt-6 text-center">
                          <p className="text-base font-semibold text-gray-800">
                            {!isLoggedIn
                              ? 'üîê Please log in'
                              : isProcessing
                              ? 'ü§î Processing...'
                              : isSpeaking
                              ? 'üîä AI Speaking...'
                              : isRecording
                              ? 'üéôÔ∏è Listening...'
                              : !isConfigured
                              ? '‚öôÔ∏è Not Configured'
                              : conversationMode
                              ? 'üîÑ Auto Mode'
                              : 'üëÜ Click to Speak'}
                          </p>
                        </div>
                      </div>

                      {/* Action Buttons */}
                      <div className="space-y-3">
                        <button
                          onClick={toggleConversationMode}
                          disabled={!isConfigured || !isLoggedIn}
                          className={`w-full px-4 py-3 rounded-lg font-medium transition ${
                            conversationMode
                              ? 'bg-gradient-to-r from-green-500 to-green-600 text-white'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          } ${!isConfigured || !isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`}
                        >
                          {conversationMode ? 'üîÑ Continuous' : '‚è∏Ô∏è Single Mode'}
                        </button>
                        
                        {messages.length > 0 && (
                          <button
                            onClick={clearHistory}
                            className="w-full px-4 py-3 rounded-lg font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition"
                          >
                            üóëÔ∏è Clear History
                          </button>
                        )}
                      </div>

                      <audio ref={audioRef} className="hidden" />
                    </div>
                  </div>

                  {/* Chat Area */}
                  <div className="lg:col-span-2">
                    <div className="bg-white rounded-2xl border-2 border-gray-200 h-[600px] flex flex-col">
                      <div className="p-6 border-b border-gray-200">
                        <div className="flex items-center justify-between">
                          <h3 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                            üí¨ Conversation
                          </h3>
                          <span className="px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-600 font-medium">
                            {messages.length} messages
                          </span>
                        </div>
                      </div>

                      {messages.length === 0 ? (
                        <div className="flex-1 flex items-center justify-center p-6">
                          <div className="text-center text-gray-400">
                            <div className="w-20 h-20 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                              <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                              </svg>
                            </div>
                            <p className="text-lg font-medium text-gray-600">No messages yet</p>
                            <p className="text-sm mt-2">Start speaking or typing to begin</p>
                          </div>
                        </div>
                      ) : (
                        <div className="flex-1 overflow-y-auto p-6 space-y-4">
                          {messages.map((msg) => (
                            <div key={msg.id} className="space-y-3">
                              <div className="flex justify-end">
                                <div className="max-w-[75%]">
                                  <div className="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-2xl rounded-tr-sm p-4">
                                    <p className="text-sm leading-relaxed">{msg.user}</p>
                                  </div>
                                  <p className="text-xs text-gray-400 mt-1 text-right">{msg.timestamp}</p>
                                </div>
                              </div>

                              <div className="flex justify-start">
                                <div className="max-w-[75%]">
                                  <div className="bg-gray-100 text-gray-800 rounded-2xl rounded-tl-sm p-4">
                                    <div className="flex items-start gap-2">
                                      <span className="text-xl">ü§ñ</span>
                                      <p className="text-sm leading-relaxed flex-1">{msg.ai}</p>
                                    </div>
                                  </div>
                                  <p className="text-xs text-gray-400 mt-1">AI Assistant</p>
                                </div>
                              </div>
                            </div>
                          ))}
                          <div ref={messagesEndRef} />
                        </div>
                      )}
                      
                      <div className="p-6 border-t border-gray-200">
                        <form onSubmit={handleTextSubmit} className="flex gap-3">
                          <input
                            type="text"
                            value={textInput}
                            onChange={(e) => setTextInput(e.target.value)}
                            placeholder="Type your message..."
                            disabled={isProcessing || !isConfigured || !isLoggedIn}
                            className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-red-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                          />
                          <button
                            type="submit"
                            disabled={isProcessing || !isConfigured || !isLoggedIn || !textInput.trim()}
                            className="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg font-medium hover:from-red-600 hover:to-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                          >
                            {isProcessing ? (
                              <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                              </svg>
                            ) : (
                              <span>üì§</span>
                            )}
                            Send
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Footer */}
              <div className="bg-gray-50 border-t border-gray-200 py-8 mt-12">
                <div className="max-w-7xl mx-auto px-6 text-center">
                  <p className="text-gray-600">
                    üí° <strong>Tip:</strong> Enable Continuous Mode for natural conversation flow
                  </p>
                  <p className="text-sm text-gray-500 mt-2">
                    Powered by Azure Speech Services & Azure OpenAI
                  </p>
                </div>
              </div>

              {/* Floating Chat Button */}
              <button className="fixed bottom-8 right-8 w-14 h-14 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-full shadow-2xl hover:from-red-600 hover:to-red-700 transition flex items-center justify-center">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              </button>
            </div>
          );
        }

        ReactDOM.render(<VoiceAIAgent />, document.getElementById('root'));
    </script>
</body>
</html>